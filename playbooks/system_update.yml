---
# Playbook: System Update
# Description: Updates all systems in the Lab Hosts inventory according to
#              their OS group, using the appropriate package manager.
#
# Inventory Groups:
#   - fedora: argus, helios, hermes (dnf)
#   - ubuntu: nebula, vega (apt)
#   - qnap: storage (skip - no package manager support)
#
# Note: helios is excluded from scheduled runs via limit in job template

- name: Update Fedora Hosts
  hosts: fedora
  gather_facts: true
  ignore_unreachable: true
  become: true
  serial: 1

  tasks:
    - name: Display update start message
      ansible.builtin.debug:
        msg: "Starting system update on {{ inventory_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})"

    - name: Check for available updates
      ansible.builtin.dnf:
        list: updates
      register: available_updates

    - name: Display number of available updates
      ansible.builtin.debug:
        msg: "{{ available_updates.results | length }} updates available"

    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_cache: true
      register: dnf_result
      when: available_updates.results | length > 0

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required_file

    - name: Check needs-restarting for services
      ansible.builtin.command: needs-restarting -r
      register: needs_restarting
      changed_when: false
      failed_when: false

    - name: Display update summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          UPDATE SUMMARY: {{ inventory_hostname | upper }}
          ============================================================
          Distribution:     {{ ansible_distribution }} {{ ansible_distribution_version }}
          Updates Applied:  {{ 'Yes' if dnf_result.changed | default(false) else 'No updates needed' }}
          Reboot Required:  {{ 'Yes' if needs_restarting.rc == 1 else 'No' }}
          ============================================================

    - name: Notify if reboot is required
      ansible.builtin.debug:
        msg: "WARNING: {{ inventory_hostname }} requires a reboot to complete updates"
      when: needs_restarting.rc == 1


- name: Update Ubuntu Hosts
  hosts: ubuntu
  gather_facts: true
  ignore_unreachable: true
  become: true
  serial: 1

  tasks:
    - name: Display update start message
      ansible.builtin.debug:
        msg: "Starting system update on {{ inventory_hostname }} ({{ ansible_distribution }} {{ ansible_distribution_version }})"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 3600

    - name: Check for available updates
      ansible.builtin.shell: apt list --upgradable 2>/dev/null | grep -c upgradable || echo "0"
      register: available_updates
      changed_when: false

    - name: Display number of available updates
      ansible.builtin.debug:
        msg: "{{ available_updates.stdout | int }} updates available"

    - name: Upgrade all packages
      ansible.builtin.apt:
        upgrade: safe
        autoremove: true
        autoclean: true
      register: apt_result

    - name: Check if reboot is required
      ansible.builtin.stat:
        path: /var/run/reboot-required
      register: reboot_required

    - name: Get list of packages requiring reboot
      ansible.builtin.command: cat /var/run/reboot-required.pkgs
      register: reboot_packages
      changed_when: false
      failed_when: false
      when: reboot_required.stat.exists

    - name: Display update summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          UPDATE SUMMARY: {{ inventory_hostname | upper }}
          ============================================================
          Distribution:     {{ ansible_distribution }} {{ ansible_distribution_version }}
          Codename:         {{ ansible_distribution_release }}
          Updates Applied:  {{ 'Yes' if apt_result.changed else 'No updates needed' }}
          Reboot Required:  {{ 'Yes' if reboot_required.stat.exists else 'No' }}
          {% if reboot_required.stat.exists and reboot_packages.stdout is defined %}
          Packages requiring reboot:
          {{ reboot_packages.stdout | indent(2) }}
          {% endif %}
          ============================================================

    - name: Notify if reboot is required
      ansible.builtin.debug:
        msg: "WARNING: {{ inventory_hostname }} requires a reboot to complete updates"
      when: reboot_required.stat.exists


- name: Skip QNAP NAS (No Package Manager)
  hosts: qnap
  gather_facts: false
  ignore_unreachable: true
  become: false

  tasks:
    - name: Display QNAP skip message
      ansible.builtin.debug:
        msg: |
          ============================================================
          SKIPPING: {{ inventory_hostname | upper }} (QNAP NAS)
          ============================================================
          QNAP NAS devices do not support automated package updates.
          Please update firmware manually via the QNAP web interface.
          ============================================================


- name: Generate Update Summary Report
  hosts: localhost
  gather_facts: false
  connection: local

  tasks:
    - name: Display final summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          SYSTEM UPDATE COMPLETE - Lab Hosts
          ============================================================

          FEDORA HOSTS UPDATED:
          {% for host in groups['fedora'] %}
            - {{ host }}
          {% endfor %}

          UBUNTU HOSTS UPDATED:
          {% for host in groups['ubuntu'] %}
            - {{ host }}
          {% endfor %}

          QNAP DEVICES SKIPPED:
          {% for host in groups['qnap'] %}
            - {{ host }} (manual update required)
          {% endfor %}

          TIMESTAMP: {{ '%Y-%m-%d %H:%M:%S' | strftime }}
          ============================================================
